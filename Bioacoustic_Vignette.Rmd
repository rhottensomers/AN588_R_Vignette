---
title: "Bioacoustic Vignette"
author: "Reese Hotten-Somers"
date: "2023-10-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Intro to Bioacoustics:
What is bioacoustics?

Who uses it?

How it's implemented?

What it can be used for and why it is important?

## Preliminaries
Install packages: {bioacoustics}, {warbleR}, {randomForest}, {Rraven}

## Objectives


## Load in Packages
```{r, prelims}
library(warbleR)
library(bioacoustics)
library(tools)
library(randomForest)



```

# Importing Data from the internet
Warblr comes with the function query_xc which allows you to seamlessly import audio data from xeno-canto[https://xeno-canto.org/484847].
```{r, importing}
#pulling all Strepera versicolor calls without downloading locally
df1 = query_xc(qword ='Strepera versicolor type:call cnt:"Australia"', download = FALSE) #todo: include explanation for parameters of query_xc

#Filter by type   
df1 = df1[df1$Vocalization_type=="call",]
df1 = df1[df1$Quality=="A",]
df1 = df1[1:9,]
View(df1)

#Download data to working directory
query_xc(X = df1, download = TRUE, path = getwd())

```

# Importing Your Own Data
However, you can also import your own MP3
```{r, importing_mp3}

```

# Reading Your file
```{r, readf}
#Just One!
STREPV <- read_audio(file.path(getwd(), "Strepera-versicolor-571957.mp3"))
STREPV


#Read them all!!!!
read_all_mp3 <- function(){
  # List all mp3 files in current directory
  mp3_files = list.files(path=".", pattern=".mp3", all.files=TRUE, 
                         full.names=TRUE)
  audio_list <- list()
  for(files in mp3_files) {
    curr_file_path <- read_audio(file.path(files))
    audio_list <- append(audio_list, curr_file_path)
  }
  return(audio_list)
}

read_all_mp3()


```

```{r, plotp}
# Display with spectro()
ticks <- c(from = 1000, to = 20000, by = 1000)

temp_slice <- c(from = 1, to = 10) # in seconds

plot(STREPV)
```

```{r, spectro}
spectro(STREPV, tlim = temp_slice, FFT_size = 512, ticks_y = ticks) #todo: figure out axis range and label it
```

```{r, fspec}
image(fspec(STREPV, tlim = temp_slice, rotate = TRUE)) #A matrix of amplitude or decibel (dB) values in the time / frequency domain.

```

If you have older zero-crossing bat vocalization patterns, then the functions write_zc() and plot_zc() will serve as replacements for fspec() and spectro(). (Add in paragraph after running through spectro and fspec() with an asterisk)
```{r, zc}
#using plot_zc #can't get this to work

zc <- write_zc(zc,filename = "mgr.wav")
zcfile <- read_zc(zc)

zcplot <- plot_zc(wav,  LPF = 125000,
                  HPF = 16000,   tlim = c(0, 10),
                  flim = c(HPF, LPF))

```



```{r, plot_data}


# blob_detection
?blob_detection
blob_detect <- blob_detection(
  STREPV, time_exp = 10, FFT_size = 512, settings = FALSE, acoustic_feat = TRUE,
  metadata = FALSE, spectro_dir = file.path(tempdir(), "Spectros"), time_scale = 0.1, ticks = TRUE)
blob_detect

# Threshold_detection
?threshold_detection
threshold_detect <- threshold_detection(
  STREPV, threshold = 12, time_exp = 1, min_dur = 140, max_dur = 440, 
  min_TBE = 10, max_TBE = 5000, EDG = 0.996, LPF = 10000, HPF = 1000, 
  FFT_size = 1024, FFT_overlap = 0.875, start_thr = 25, end_thr = 30, 
  SNR_thr = 10, angle_thr = 45, duration_thr = 440, NWS = 1000, 
  KPE = 1e-05, KME = 1e-04, settings = FALSE, acoustic_feat = TRUE,
  metadata = FALSE, spectro_dir = file.path(tempdir(), "Spectros"), time_scale = 1, 
  ticks = c(1000, 10000, 1000) # Tick marks from 1 to 10 kHz with 1 kHz interval
) 
threshold_detection


# auto_detec automatically detects the start and end of vocalizations in sound files based on amplitude, duration, and frequency range attributes.
# https://rdrr.io/cran/warbleR/man/auto_detec.html
?auto_detec
detection <- auto_detec(threshold = 5, ssmooth = 300, bp = c(2, 9), wl = 300, path = getwd())
detection

#Warning: This function will be deprecated in future warbleR versions, please look at the ohun package for automatic signal detection functions 
library(ohun)
library(viridis)

detection$sound.files
label_spectro(wave = STREPV, detection = detection[detection$sound.files == "Strepera-versicolor-571957.mp3", ], hop.size = 10, ovlp = 50, flim = c(1, 10), fastdisp=TRUE) 

```

```{r, yourowndata}
#Loading in own recording #Challenge

wav <- read_audio(file.path(getwd(), "mgr.wav"))

#Displaying your sound
# Display with spectro()
ticks <- c(from = 1000, to = 20000, by = 1000) # Frequency tick marks from 1 to 20 kHz, and steps at each 1 kHz
temp_slice <- c(from = 1, to = 10) # Time slice in seconds

spectro(wav, tlim = temp_slice, FFT_size = 512, ticks_y = ticks)

# Display with fspec
# fspec() gives you the spectrogram matrix with energy values (dB)
spec_mx <- fspec(wav, tlim = temp_slice, FFT_size = 512, rotate = TRUE)

# You can display the spectrogram with image()
image(spec_mx, xaxt = "n", yaxt = "n")

# Set each argument according to the targeted audio events
TD <- threshold_detection(
  wav, 
  threshold = 12,   time_exp = 1,  min_dur = 140,   max_dur = 440,   min_TBE = 10,  max_TBE = 5000, 
  EDG = 0.996, 
  LPF = 10000, 
  HPF = 1000, 
  FFT_size = 256, 
  FFT_overlap = 0.875, 
  start_thr = 25, 
  end_thr = 30, 
  SNR_thr = 10, 
  angle_thr = 45, 
  duration_thr = 440, 
  NWS = 1000, 
  KPE = 1e-05, 
  KME = 1e-04, 
  settings = FALSE, 
  acoustic_feat = TRUE, 
  metadata = FALSE, 
  spectro_dir = file.path(tempdir(), "Spectros"), 
  time_scale = 1, 
  ticks = TRUE
)

nrow(TD$data$event_data)


#this is the same
BD <- blob_detection(
  wav, # Either a path to an audio file (see ?read_audio), or a Wave object
  time_exp = 10, # Time expansion factor of 10 for time expanded recordings.
  min_dur = 1.5, # Minimum duration threshold of 1.5 milliseconds (ms)
  max_dur = 80, # Maximum duration threshold of 80 ms
  min_area = 40, # minimum number of 40 pixels in the blob
  min_TBE = 20, # Minimum time window between two audio events of 20 milliseconds
  EDG = 0.996, # Temporal masking with Exponential Decay Gain from 0 to 1
  LPF = slot(myotis, "samp.rate") * 10 / 2, # Low-Pass Filter at the Nyquist frequency
  HPF = 16000, # High-Pass Filter of 16 kHz
  FFT_size = 256, # Size of the Fast Fourrier Transform (FFT) window
  FFT_overlap = 0.875, # Percentage of overlap between two FFT windows
  
  blur = 2, # Gaussian smoothing function with a factor of 2 for blurring the spectrogram
  bg_substract = 20, # Foreground extraction with a mean filter applied on the spectrogram
  contrast_boost = 20, # Edge contrast enhancement filter of the spectrogram contour
  
  settings = FALSE, #  Save on a list the above parameters set with this function
  acoustic_feat = TRUE, # Extracts the acoustic and signal quality parameters 
  metadata = FALSE, # Extracts on a list the metadata embedded with the Wave file
  spectro_dir = file.path(tempdir(), "Spectros"), # HTML page with spectrograms by order of detection 
  time_scale = 0.1, # Time resolution of 2 ms for spectrogram display
  ticks = TRUE # Tick marks and their intervals are drawn on y-axis (frequencies)
) 


```


